#!/bin/bash
# llpp-gc - remove llpp.conf history entries for resources that no longer exist
# requires xmlstarlet

# Do not use this with llpp -gc, llpp-gc is an independent tool.

set +e
readonly cfg=${LOCALDIR:-$HOME/local}/cfg/llpp/llpp.conf

while read -r f; do
    # Remove any result which doesn't exist or isn't an absolute path otherwise
    # llpp's behaviour could change depending on its working directory.
    if [[ ! -e $f ]] || [[ $f != /* ]]; then
        xmlstarlet ed -O -L -d "//llppconfig/doc[@path='$f']" "$cfg"
        printf 'removed %s\n' "$f" >&2
    fi
done < <(xmlstarlet sel -T -t -m //llppconfig/doc/@path -v . -n "$cfg")
