#!/bin/bash
# repo-cycle-detector - attempt to detect cycles in pacman repos

set +e

parse() {
    # We assume a package name cannot contain this FS.
    awk -F : '{ 
        p = $1

        # If we find that a package contains no dependency, make it a
        # dependency of itself to provide tsort a complete graph.
        if($2 == "")
            $2 = $1

        for(i = 1; i <= NF; ++i)
            print p, $i
    }'
}

if ((!$#)); then
    printf 'usage: repo-cycle-detector repo\n' >&2
    exit 1
fi

# The format is formally package:dependency0:dependency1:..:dependency(n)

# We feed expac explicitly from /dev/stdin as otherwise expac will attempt
# to find all possible packages.

# See <https://github.com/falconindy/expac/issues/24>
expac -S '%n:%E' -l ':' - < <( pacsift --exact --repo="$1") | parse | tsort > /dev/null
