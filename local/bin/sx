#!/bin/sh --
# sx - simpler startx

# requires svlogd xorg fgconsole

# An svlogd implementation can be found in busybox:
#   % ln -s /bin/busybox ~/local/bin/svlogd

# This script doesn't allow passing arguments to the xserver.  Instead edit
# this file if different options are necessary.

# Make sure we aren't already running in an Xserver.
if [ "$DISPLAY" ]; then
    printf -- '%s: DISPLAY already set\n' "$DISPLAY" >&2
    exit 1
fi

if ! tty=$(fgconsole); then
    exit
fi

readonly localdir=${LOCALDIR:-$HOME/local}
readonly cfgdir=$localdir/cfg/X11
readonly logdir=$localdir/var/log/X11/xinit.$tty
readonly logfile=$localdir/var/log/X11/xserver.$tty

# Honour XINITRC as per xinit(1) documentation.
xinitrc=${XINITRC:-$cfgdir/xinitrc}

if ! mkdir -p "$cfgdir" "$logdir"; then
    exit
fi

export DISPLAY=:$tty

# * Since Xorg 1.17 the -nolisten command has been removed:
#   <https://cgit.freedesktop.org/xorg/xserver/commit/?id=cc59be38b>

# * -keeptty is now implicitly enabled when we run the Xserver on the same tty,
#   however it still needs to be explicitly set for whatever reason.
#   <https://cgit.freedesktop.org/xorg/xserver/commit/?id=6b79f28f5>
xinit "${@:-$xinitrc}" -- "$DISPLAY" vt"$tty" -logfile "$logfile" -keeptty 2>&1 | svlogd -tt "$logdir"
