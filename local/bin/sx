#!/bin/bash
# sx - simpler startx

# requires svlogd xorg>=1.18

# This script doesn't allow passing arguments to the Xserver.  Instead edit
# this file if different options are necessary.

# Make sure we aren't running in an Xserver.
if [[ $DISPLAY ]]; then
    printf '%s: DISPLAY is already set\n' "$DISPLAY" >&2
    exit 1
fi

if [[ ! $XDG_VTNR ]]; then
    printf 'XDG_VTNR is not available\n' >&2
    exit 1
fi

if [[ ! $XDG_RUNTIME_DIR ]]; then
    printf 'XDG_RUNTIME_DIR is not available\n' >&2
    exit 1
fi

readonly localdir=${LOCALDIR:-$HOME/local}

readonly cfgdir=$localdir/cfg/X11
readonly logdir=$localdir/var/log/X11/xinit.$XDG_VTNR
readonly logfile=$localdir/var/log/X11/xserver.$XDG_VTNR
readonly rundir=$XDG_RUNTIME_DIR/X11

# Honour XINITRC as per xinit(1) documentation.
xinitrc=${XINITRC:-$cfgdir/xinitrc}

mkdir -p "$cfgdir" "$logdir" "$rundir"

export DISPLAY=:$XDG_VTNR
export XAUTHORITY=$rundir/XAuthority

# Such as ICEAuthority.
unset SESSION_MANAGER

# I can blindly add a new entry with xauth as this is stored in a tmpfs
# (RUNTIME_DIR) which is destroyed after a reboot.
xauth -q add "$DISPLAY" . "$(mcookie)" &> /dev/null

# * Since Xorg 1.17 the -nolisten command has been removed:
#   https://cgit.freedesktop.org/xorg/xserver/commit/?id=cc59be38b

# * -keeptty is now implicitly enabled when we run the Xserver on the same tty:
#   https://cgit.freedesktop.org/xorg/xserver/commit/?id=6b79f28f5
args=(vt"$XDG_VTNR" -auth "$XAUTHORITY" -logfile "$logfile")
exec xinit "${@:-$xinitrc}" -- "$DISPLAY" "${args[@]}" |& svlogd -tt "$logdir"
