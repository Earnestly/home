#!/bin/bash
# sx - simpler startx
# NOTE: This script only takes a single client with no arguments.

# Make sure we aren't running in an Xserver.
if [[ $DISPLAY ]]; then
    printf '%s: DISPLAY is already set\n' "$DISPLAY" >&2
    exit 1
fi

if [[ ! $XDG_VTNR ]]; then
    printf 'XDG_VTNR is not available\n' >&2
    exit 1
fi

if [[ ! $XDG_RUNTIME_DIR ]]; then
    printf 'XDG_RUNTIME_DIR is not available\n' >&2
    exit 1
fi

readonly confdir=${XDG_CONFIG_HOME:-$HOME/local/cfg}/X11
readonly logdir=${XDG_CACHE_HOME:-$HOME/local/var/cache/log}/X11
readonly rundir=$XDG_RUNTIME_DIR/X11

# Honour XINITRC as per xinit(1) documentation.
xinitrc=${XINITRC:-$confdir/xinitrc}


mkdir -p "$confdir" "$logdir" "$rundir"

export DISPLAY=:$XDG_VTNR
export XAUTHORITY=$rundir/XAuthority

# After days of Xorg running this logfile can become fairly large and as it's
# almost never needed I just discard it instead.
log=/dev/null
#log=$logdir/$DISPLAY.log

# Such as ICEAuthority.
unset SESSION_MANAGER

# I blindly add a new entry with xauth as this is stored in a tmpfs and thus
# destroyed after a reboot.
xauth -q add "$DISPLAY" . "$(mcookie)" &> /dev/null

serveropts=(
    vt"$XDG_VTNR" 
    # Logfile can be only set for rootful servers, this option is ignored for
    # rootless uses of the Xserver.
    # -logfile "${LOCALDIR:-$HOME/local}"/var/log/xorg."$DISPLAY".log
    -keeptty
    -nolisten tcp 
    -auth "$XAUTHORITY"
)

exec xinit "${1:-$xinitrc}" -- "$DISPLAY" "${serveropts[@]}" "${@:2}" 2> "$log"
