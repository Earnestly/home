#!/bin/python3
# djview-gc - remove DjView.conf history entries for files that no longer exist

import os
import sys
import configparser
from urllib.parse import urlparse


def confdir(*args) -> str:
    xdg = os.environ.get('XDG_CONFIG_HOME')

    if xdg is None or not os.path.isabs(xdg):
        xdg = os.path.expanduser('~/.config')

    return os.path.join(xdg, *args)


config = confdir('DjVuLibre/DjView.conf')

ini = configparser.ConfigParser(allow_no_value=True)

# Preserve the case for the keys as otherwise djview won't understand it.
ini.optionxform = str
ini.read(config)

if not ini.sections():
    sys.exit('djview-gc: {0}: empty file'.format(config))

recentfiles = ini['General']['recentFiles']
urls = [u.strip('"') for u in recentfiles.split(', ')]

extants = []

for url in urls:
    r = urlparse(url)

    if os.path.isfile(r.path):
        extants.extend(['"' + r.scheme + '://' + r.path + '?' + r.query + '"'])
    else:
        print('djview-gc: removed entry: {0}'.format(r.path))

ini['General']['recentFiles'] = ','.join(extants)

with open(config, 'w') as cfg:
    ini.write(cfg)
