#!/usr/bin/env python3

import os
import sys
import configparser
from urllib.parse import urlparse


def main():
    localdir = os.environ.get('LOCALDIR')

    if localdir is None or not os.path.isabs(localdir):
        localdir = os.path.expanduser('~/local')

    config = os.path.join(localdir, 'cfg', 'DjVuLibre/DjView.conf')

    ini = configparser.ConfigParser(allow_no_value=True)
    ini.optionxform = str  # Preserve case in keys

    ini.read(config)

    if not ini.sections():
        sys.exit('{0}: Empty file'.format(config))

    recentfiles = ini['General']['recentFiles'].replace(', ', ' ')
    urls = [u for u in [u.strip() for u in recentfiles.split('"')] if u]

    survivors = []

    for url in urls:
        r = urlparse(url)
        path = r.path
        query = r.query
        scheme = r.scheme

        if not os.path.isfile(path):
            print('Removing {0}'.format(path))
        else:
            survivors.extend(['"' + scheme + '://' + path + '?' + query + '"'])

    ini['General']['recentFiles'] = ",".join(survivors)

    with open(config, 'w') as cfg:
        ini.write(cfg)


if __name__ == '__main__':
    main()
