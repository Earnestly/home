#!/bin/sh --
# ditch - display menu of live twitch streamers from list of stream IDs

# requires awk jq curl bemenu mpv youtube-dl streamlink

# Feel free to use these API keys.
# Backup: jzkbprff40iqj646a697cyrvl0zt2m6 (youtube-dl)
client_id=rfbp97unyyikyzw1y9cy87iii29lgjk
client_version=application/vnd.twitchtv.v5+json

chunkurls() {
    # Twitch only allows a maximum of 100 streamers in a single query.
    # https://dev.twitch.tv/docs/v5/reference/streams/#get-stream-by-user
    xargs -n 100 | awk '
    BEGIN{
        OFS = ","
    }

    NF{
        $1 = $1
        printf "https://api.twitch.tv/kraken/streams?channel=%s&limit=%d\n", $0, NF
    }'
}

# NOTE: This leaves the responsibility of multi-tasking potentially many
#       processes to the kernel.  Neither gnu parallel(1) or xargs(1) proved
#       to be very capable of this without complication and awkwardness, and
#       neither were any faster.
pulljson() {
    while read -r url; do
        curl -sH "Accept: $client_version" -H "Client-ID: $client_id" "$url" | readjson &
    done

    wait
}

readjson() {
    jq -r '.streams[] | [.viewers, .channel.name, .channel.game[:50], .channel.status] | @tsv'
}

viewsort() {
    sort -t '	' -nr | cut -f2- | column -ts '	'
}

stream() {
    while read -r streamer _; do
        if [ "$streamer" ]; then
            # Background in order to support multiple selections.
            streamlink -vp 'mpv --quiet' -t 'MPV:{author}:{title}' --hls-live-edge 10 https://twitch.tv/"$streamer" best &
        fi
    done
}

chunkurls | pulljson | viewsort | menu --ifne -l 30 -p STREAM | stream
