#!/bin/sh --
# ditch - display menu of live twitch streamers from list of stream IDs
# requires mktemp jq curl bemenu mpv youtube-dl

# NOTE
#   - Cannot use curl -Z without the use of a temporary directory yet:
#     <https://github.com/curl/curl/issues/5175>

# This API key is found on every twitch page.
id=kimne78kx3ncx6brgo4mv6wki5h1ko
maxquery=100

tmp=$(mktemp -d /tmp/ditch_XXXX)
trap 'rm -rf -- "$tmp"' EXIT

xargs -E '' -n "$maxquery" | while read -r section; do
    # A section is a series of space separated integers generated elsewhere.
    # shellcheck disable=SC2086
    set -- $section

    IFS=,
    printf 'url https://api.twitch.tv/kraken/streams?channel=%s&limit=%d\n' "$*" "$#"
    unset IFS

    i=$((i + 1))
    printf 'output %s/%d\n' "$tmp" "$i"
    printf 'write-out %%{filename_effective}\\n\n'
done\
    | curl -sZH 'Accept: application/vnd.twitchtv.v5+json' -H "Client-ID: $id" -K - \
    | xargs -E '' jq -rs 'map(.streams[]) | sort_by(-.viewers)[] | [.channel.name, .channel.game[:50], .channel.status] | @tsv' \
    | column -ts '	' \
    | menu --ifne -l 30 -p STREAM | while read -r streamer _; do
        if [ "$streamer" ]; then
            mpv --quiet https://twitch.tv/"$streamer" &
        fi
    done
