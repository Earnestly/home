#!/bin/sh --
# mkwineprefix - creates a sane wine prefix

# Unlinks all directories pointing at the users home, optionally remaps z: to
# /mnt instead of / and disables winemenubuilder to prevent .desktop/mime
# pollution

# TODO complete a mechanism to load external registery snippets

argv0=mkwineprefix

usage() {
    cat >&2 <<!
usage: mkwineprefix [-a arch] [-m] [-g] [-r] [-h] prefix

options
    -a arch  Architecture, 32 or 64 (Default: 32)
    -m       Enable Mono installation
    -g       Enable Gecko installation
    -r       Remap z: to /mnt instead of /
    -h       This help message

prefix
    The path to the prefix, pwd prepended if not absolute.
!
}

errx() {
    printf -- "%s: $2" "$argv0" "${@:3}" >&2
    exit "$1"
}

# We need at least one argument.
if [ "$#" -eq 0 ]; then
    errx 1 'usage: mkwineprefix [-a arch] [-m] [-g] [-r] [-h] prefix\n'
fi

while true; do
    case $1 in
        --) shift; break ;;
        -a) shift; arch=$1
            case $arch in
                '') arch=32 ;;
                32) export WINEARCH=win32 ;;
                64) export WINEARCH=win64 ;;
                *)  errx 1 '%s: invalid architecture (32 or 64)\n' "$arch" ;;
            esac ;;
        -g) with_gecko=1 ;;
        -m) with_mono=1 ;;
        -r) remap_z=1 ;;
        -h) usage
            exit
            ;;
        -?) errx 1 '%s: unknown option\n' "$1" ;;
        *)  break
    esac
    shift
done

prefix=$1

if ! prefix=$(readlink -f "$prefix"); then
   errx 1 '%s: unable to determine canonical path\n' "$1"
fi

export WINEPREFIX="$prefix"

# Check if the prefix already exists using dosdevices as a sentinel.  If it
# does simply return the prefix location and exit.
if [ -d "$WINEPREFIX"/dosdevices ]; then
    printf -- '%s\n' "$WINEPREFIX"
    errx 0 '%s: prefix already exists\n' "$WINEPREFIX"
fi

# Enable both if set by unsetting overrides.
if [ "$with_mono" ] && [ "$with_gecko" ]; then
    export WINEDLLOVERRIDES='winemenubuilder.exe=d'
elif [ "$with_mono" ]; then
    export WINEDLLOVERRIDES='winemenubuilder.exe,mshtml=d'
elif [ "$with_gecko" ]; then
    export WINEDLLOVERRIDES='winemenubuilder.exe,mscoree=d'
else
    export WINEDLLOVERRIDES='winemenubuilder.exe,mscoree,mshtml=d'
fi

# Initialise the prefix now so we can fix it before any work is done with it.
if ! wine wineboot -i; then
    errx "$?" 'wineboot\n'
fi

# Remap Z: which limits what wine can see, the default / gives access to
# everything the user does.  Selecting /mnt as an alternative due to most isos
# being mounted there for installation purposes.
if [ "$remap_z" ]; then
    if [ -d "$WINEPREFIX"/dosdevices/z: ]; then
        rm -f -- "$WINEPREFIX"/dosdevices/z:

        # Recreate it and point to /mnt instead of /.
        ln -sf -- /mnt "$WINEPREFIX"/dosdevices/z:
    fi
fi

# Remove all the symlinks pointing at the user home directory.
# Note: Since a prefix is always going to be created as Windows XP we don't
#       need to test for windows 7+ directories.  This would only matter if
#       we were going to modify extant prefixes.
for dir in Desktop 'My Documents' 'My Music' 'My Pictures' 'My Videos'; do
    rm -rf -- "$WINEPREFIX"/drive_c/users/"$USER"/"$dir"
    mkdir -p -- "$WINEPREFIX"/drive_c/users/"$USER"/"$dir"
done

# Return the created prefix.
printf -- '%s\n' "$WINEPREFIX"

# cat > "$WINEPREFIX"/colors.reg <<!
# REGEDIT4
# [HKEY_CURRENT_USER\Control Panel\Colors]
# "Background"="33 33 33"
# !

# cat > "$WINEPREFIX"/virtual_desktop.reg <<!
# REGEDIT4
# [HKEY_CURRENT_USER\Software\Wine\Explorer]
# "Desktop"="Default"
# [HKEY_CURRENT_USER\Software\Wine\Explorer\Desktops]
# "Default"="1024x786"
# !

# wine regedit /S "$WINEPREFIX"/colors.reg
# wine regedit /S "$WINEPREFIX"/virtual_desktop.reg
