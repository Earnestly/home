#!/bin/bash
# asr - download arch linux build files from the svntogit repositories

# requires git expac pacman

readonly argv0=asr

error() {
    printf -- "%s: $1" "$argv0" "${@:2}" > /dev/stderr
}

if [[ ! $1 ]]; then
    error 'usage: asr package\n'
    exit 1
fi

package=$1

repos=('git://projects.archlinux.org/svntogit/packages.git'
       'git://projects.archlinux.org/svntogit/community.git')

for repo in "${repos[@]}"; do
    # Determine which repository the package exists in.
    if git ls-remote --exit-code "$repo" refs/heads/packages/"$package"; then
        git clone -nb packages/"$package" --single-branch "$repo" "$package"
        # Break out if we succeed to avoid duplicate packages being found.
        break
    fi
done

if cd "$package" 2> /dev/null; then
    git checkout HEAD:trunk -- .
else
    error '%s: Could not find package\n' "$package"

    if pkgbase=$(expac -S %e "$package"); then
        error '%s: Base package for %s\n' "$pkgbase" "$package"
    fi

    if ! pacman -T "$package" > /dev/null; then
        error '%s: Not available in official repositories\n' "$package"
    fi
fi
