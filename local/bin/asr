#!/bin/bash
# asr - download arch linux build files from the svntogit repositories

# requires git pacsift expac

if [[ ! $1 ]]; then
    printf 'usage: asr package\n' >&2
    exit 1
fi

package=$1

repos=('git://projects.archlinux.org/svntogit/packages.git'
       'git://projects.archlinux.org/svntogit/community.git')

for repo in "${repos[@]}"; do
    # Determine which repository the package exists in.
    if git ls-remote --exit-code "$repo" refs/heads/packages/"$package"; then
        git clone -nb packages/"$package" --single-branch "$repo" "$package"
        # Break out if we succeed to avoid duplicate packages being found.
        break
    fi
done

if cd "$package"; then
    git checkout HEAD:trunk -- .
else
    pkgbase=$(expac -S %e "$package")
    printf '%s: Could not find package\n' "$package" >&2

    if [[ $pkgbase != '(null)'* ]]; then
        printf '%s might be part of the %s split-package\n' "$package" "$pkgbase" >&2
    fi
fi
