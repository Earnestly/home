#!/bin/sh
# stackage-update-config
# Requires: curl, ed
# This script exists because cabal and cabal-install are possibly some of the
# worst tools I've ever used which is all the more bitter given such an elegant
# language.

TMPDIR=/tmp

readonly cabal_config="${XDG_DATA_HOME:-$HOME/.local/share}"/cabal/config
readonly stackage_config="$TMPDIR"/stackage.config

fetch() {
    curl -sLo "$1" 'http://www.stackage.org/nightly/cabal.config?global=true'

    # Remove useless comments and enable the repo.  This is a terrible hack for
    # assuming the file will have four comments before the remote-repo
    # declaration.
    sed -i '1,4d; s/^-- //' "$1"
}

combine_config() {
    printf 'g/^remote-repo: stackage/d\ng/^constraint:/d\n$ r %s\nw\n' "$2" | ed -s "$1"
}

if fetch "$stackage_config"; then
    combine_config "$cabal_config" "$stackage_config"
    rm -rf -- "$stackage_config"
fi
