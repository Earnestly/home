#!/bin/bash
# ~/.local/bin/srl
# Create a dmenu of current live streamers from speedrunslive

declare -A names
dopts=(-p "streams:" -fn "Dina Bold 8" -i -l 20)
jshopts=(-e channels -a -e channel -e name -u -p -e title -u -p -e link -u)

# XXX Not happy about this, and generally the entire structure
fail() {
    if (($? != 0)); then
        # Provide some feedback if there's an error
        i3-nagbar -f "pango: Dina Bold 8" -m "srl: Error downloading json data"
        exit 1
    fi
}

# Here we go!  
srl=$(curl -s 'http://api.twitch.tv/api/team/srl/live_channels.json' || fail)
sda=$(curl -s 'http://api.twitch.tv/api/team/sda/live_channels.json' || fail)

# First line is always the streamer's name, followed by the title and then the
# streamer's url
while { 
    read -r name
    read -r title
    read -r url 
}; do 
    # Store the name and title for dmenu to display as the key in an associative
    # array where the url is the value.
    names["$name ($title)"]="$url"
done < <(jshon "${jshopts[@]}" <<< "$sda"
         jshon "${jshopts[@]}" <<< "$srl")


# Display the keys and store it as the selection
selection=$(printf "%s\n" "${!names[@]}" | sort | dmenu "${dopts[@]}")
if (($? == 0)); then
    # Blindly pass the value based on the key from selection to lstream
    exec lstream "${names[$selection]}"
fi
